<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ミュージックプレイヤー</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
  <script src="../js/i18n.js"></script>
  <style>
    /* et-movie.html に合わせたビジュアル（暫定） */
    :root{
      --bg:#0b0c10;
      --card:#0f1720;
      --glass: rgba(255,255,255,0.04);
      --accent: #ff7a7a;
      --muted: rgba(255,255,255,0.7);
      --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: "Noto Sans JP","Open Sans",sans-serif;
      background: linear-gradient(180deg,#06060a 0%, #0b0c10 100%);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* 背景ポスター（blur） */
    .hero-bg{
      position:fixed;inset:0;z-index:0;background-size:cover;background-position:center;filter:blur(14px) brightness(0.45);
    }

    /* コンテナ */
    .page-wrap{
      position:relative;z-index:2;height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;
    }

    /* 中央カード（映画ページ風に横長） */
    .movie-card{
      width:1100px;max-width:96vw;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18));
      box-shadow:0 24px 60px rgba(0,0,0,0.7);
      display:flex;gap:28px;overflow:hidden;padding:18px;align-items:stretch;
    }

    .poster{
      width:380px;min-width:280px;border-radius:10px;overflow:hidden;flex-shrink:0;
      box-shadow:0 20px 40px rgba(0,0,0,0.6);
      background:#111;
    }
    .poster img{width:100%;height:100%;object-fit:cover;display:block}

    .content{
      flex:1;display:flex;flex-direction:column;justify-content:space-between;padding:12px 6px;
    }

    .meta{
      padding:8px 6px;
    }
    .title-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .title-block{min-width:0}
    .title{font-size:1.6rem;font-weight:700;line-height:1.1}
    .subtitle{color:var(--muted);margin-top:6px;font-size:0.95rem}

    .controls{
      margin-top:18px;display:flex;align-items:center;gap:14px;
    }

    /* 大きなプレイボタン（中央に寄せるデザイン） */
    .play-circle{
      width:88px;height:88px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent),#4ecdc4);border:none;cursor:pointer;box-shadow:0 12px 36px rgba(78,205,196,0.12);
      transition:transform .12s;
      flex-shrink:0;
    }
    .play-circle:hover{transform:scale(1.03)}
    .play-circle .material-icons{font-size:40px;color:#fff}

    .small-controls{display:flex;gap:10px;align-items:center}
    .icon-btn{width:48px;height:48px;border-radius:10px;background:var(--glass);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .icon-btn .material-icons{font-size:20px;color:#fff}

    .progress-wrap{margin-top:18px}
    .progress{
      height:10px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;cursor:pointer;
    }
    .progress > .fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#4ecdc4);transition:width .08s linear}

    .time-row{display:flex;justify-content:space-between;color:var(--muted);font-size:0.9rem;margin-top:8px}

    .playlist{
      margin-top:18px;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;max-height:220px;overflow:auto;
    }
    .pl-item{display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
    .pl-item.active{background:linear-gradient(90deg, rgba(255,120,120,0.08), rgba(78,205,196,0.05))}
    .pl-thumb{width:56px;height:56px;border-radius:8px;overflow:hidden;background:#222}
    .pl-thumb img{width:100%;height:100%;object-fit:cover}
    .pl-info{min-width:0;flex:1}
    .pl-title{font-weight:600}
    .pl-sub{color:var(--muted);font-size:0.9rem}

    /* フッタースタイル（小型のメタや共有） */
    .meta-foot{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:12px;color:var(--muted);font-size:0.95rem}

    @media(max-width:980px){
      .movie-card{flex-direction:column;align-items:center}
      .poster{width:68%;max-width:420px}
      .play-circle{width:72px;height:72px}
    }
  </style>
</head>
<body>
  <!-- 背景ポスター（get from first track when loaded） -->
  <div id="hero-bg" class="hero-bg" style="background-image:url('https://via.placeholder.com/1600x900/111111/ffffff?text=Music+Background')"></div>

  <div class="page-wrap">
    <section class="movie-card" role="region" aria-label="Music player card">
      <div class="poster" id="poster"><img id="poster-img" src="https://via.placeholder.com/600x600/ff6b6b/ffffff?text=Album" alt="Poster"></div>

      <div class="content">
        <div class="meta">
          <div class="title-row">
            <div class="title-block">
              <div class="title" id="title-text">楽しい音楽</div>
              <div class="subtitle" id="subtitle-text">アーティスト名 • プレイリスト</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
              <button class="icon-btn" id="fav-btn" title="お気に入り"><span class="material-icons">favorite_border</span></button>
              <button class="icon-btn" id="share-btn" title="共有"><span class="material-icons">share</span></button>
            </div>
          </div>

          <div class="controls">
            <button class="play-circle" id="play-main" aria-label="再生/一時停止"><span class="material-icons" id="play-main-icon">play_arrow</span></button>

            <div style="display:flex;flex-direction:column;flex:1;gap:8px">
              <div style="display:flex;align-items:center;gap:12px">
                <div class="small-controls">
                  <button class="icon-btn" id="prev" title="前へ"><span class="material-icons">skip_previous</span></button>
                  <button class="icon-btn" id="toggle" title="再生/一時停止"><span class="material-icons" id="toggle-icon">play_arrow</span></button>
                  <button class="icon-btn" id="next" title="次へ"><span class="material-icons">skip_next</span></button>
                </div>
                <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
                  <span style="color:var(--muted);font-size:0.95rem">音量</span>
                  <input type="range" id="vol" min="0" max="100" value="70" style="width:120px">
                </div>
              </div>

              <div class="progress-wrap">
                <div class="progress" id="progress"><div class="fill" id="fill"></div></div>
                <div class="time-row"><span id="cur">0:00</span><span id="total">0:00</span></div>
              </div>
            </div>
          </div>

          <div class="playlist" id="playlist" aria-live="polite">
            <!-- playlist items populated by JS -->
          </div>
        </div>

        <div class="meta-foot">
          <div id="desc" style="flex:1;color:var(--muted)">説明文：ここにプレイリストの説明やメモが表示されます。</div>
          <div style="min-width:160px;text-align:right;color:var(--muted)">プレイリスト長: <span id="pl-length">0</span></div>
        </div>
      </div>
    </section>
  </div>

  <audio id="audio" preload="metadata"></audio>

  <script>
    // 既存のロジックをほぼ流用 — DOM idを合わせました
    const urlParams = new URLSearchParams(window.location.search);
    const playlistId = urlParams.get('playlist') || 'relaxing-music';

    const audio = document.getElementById('audio');
    const playMain = document.getElementById('play-main');
    const playMainIcon = document.getElementById('play-main-icon');
    const toggleBtn = document.getElementById('toggle');
    const toggleIcon = document.getElementById('toggle-icon');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const vol = document.getElementById('vol');
    const progress = document.getElementById('progress');
    const fill = document.getElementById('fill');
    const cur = document.getElementById('cur');
    const total = document.getElementById('total');
    const playlistEl = document.getElementById('playlist');
    const posterImg = document.getElementById('poster-img');
    const heroBg = document.getElementById('hero-bg');
    const titleText = document.getElementById('title-text');
    const subtitleText = document.getElementById('subtitle-text');
    const plLength = document.getElementById('pl-length');

    let playlist = null;
    let index = 0;
    let playing = false;

    function loadPlaylist(){
      playlist = window.getContentData && window.getContentData.getById ? getContentData.getById(playlistId) : null;
      if(!playlist || !playlist.isMusicPlaylist){
        playlistEl.innerHTML = '<div style="padding:12px;color:rgba(255,255,255,0.6)">プレイリストが見つかりません。</div>';
        return;
      }
      titleText.textContent = playlist.title || 'プレイリスト';
      subtitleText.textContent = (playlist.author || 'Unknown') + ' • ' + (playlist.tracks.length + ' 曲');
      plLength.textContent = playlist.tracks.length;
      renderPlaylist();
      loadTrack(0,false);
      // set hero background from first track art
      const art = (playlist.tracks[0] && playlist.tracks[0].art) || '';
      if(art){
        heroBg.style.backgroundImage = `url('${art}')`;
        posterImg.src = art;
      }
    }

    function renderPlaylist(){
      playlistEl.innerHTML = '';
      playlist.tracks.forEach((t,i)=>{
        const div = document.createElement('div');
        div.className = 'pl-item' + (i===index ? ' active' : '');
        div.innerHTML = `<div class="pl-thumb"><img src="${t.art||'https://via.placeholder.com/80'}" alt=""></div>
          <div class="pl-info"><div class="pl-title">${t.title}</div><div class="pl-sub">${t.artist||''}</div></div>
          <div style="color:var(--muted)">${t.duration||''}</div>`;
        div.onclick = ()=>{ loadTrack(i); playIfPaused(); };
        playlistEl.appendChild(div);
      });
      // scroll active into view
      const active = playlistEl.querySelector('.pl-item.active');
      if(active) active.scrollIntoView({behavior:'smooth',block:'center'});
    }

    function loadTrack(i,autostart=true){
      if(!playlist) return;
      index = i;
      const t = playlist.tracks[i];
      audio.src = t.url || '';
      titleText.textContent = t.title;
      subtitleText.textContent = t.artist || '';
      posterImg.src = t.art || posterImg.src;
      // hero background
      heroBg.style.backgroundImage = `url('${t.art||heroBg.style.backgroundImage.replace('url(','').replace(')','') }')`;
      renderPlaylist();
      updateIcons();
      audio.load();
      if(autostart && playing) audio.play().catch(()=>{});
    }

    function playIfPaused(){ if(!playing) togglePlay(); }

    function togglePlay(){
      if(!audio.src) return;
      if(playing) audio.pause(); else audio.play().catch(()=>{});
      playing = !playing;
      updateIcons();
    }
    function updateIcons(){
      const ic = playing ? 'pause' : 'play_arrow';
      playMainIcon.textContent = ic;
      toggleIcon.textContent = ic;
    }

    prevBtn.addEventListener('click', ()=>{
      if(!playlist) return;
      index = (index -1 + playlist.tracks.length) % playlist.tracks.length;
      loadTrack(index, playing);
    });
    nextBtn.addEventListener('click', ()=>{
      if(!playlist) return;
      index = (index +1) % playlist.tracks.length;
      loadTrack(index, playing);
    });
    playMain.addEventListener('click', togglePlay);
    toggleBtn.addEventListener('click', togglePlay);

    vol.addEventListener('input', (e)=>{ audio.volume = e.target.value/100; });

    audio.addEventListener('timeupdate', ()=>{
      if(!audio.duration || !isFinite(audio.duration)) return;
      const p = Math.max(0,Math.min(1,audio.currentTime / audio.duration));
      fill.style.width = (p*100)+'%';
      cur.textContent = formatTime(audio.currentTime);
    });
    audio.addEventListener('loadedmetadata', ()=>{ total.textContent = formatTime(audio.duration); });
    audio.addEventListener('ended', ()=>{ nextBtn.click(); if(playing) audio.play().catch(()=>{}); });

    progress.addEventListener('click', (e)=>{
      if(!audio.duration) return;
      const r = progress.getBoundingClientRect();
      const pct = (e.clientX - r.left)/r.width;
      audio.currentTime = pct * audio.duration;
    });

    document.addEventListener('keydown',(e)=>{
      if(e.code==='Space'){ e.preventDefault(); togglePlay(); }
      if(e.code==='ArrowLeft'){ prevBtn.click(); }
      if(e.code==='ArrowRight'){ nextBtn.click(); }
    });

    function formatTime(s){
      if(!isFinite(s)) return '0:00';
      const m = Math.floor(s/60); const sec = Math.floor(s%60);
      return `${m}:${sec.toString().padStart(2,'0')}`;
    }

    // 初期化
    loadPlaylist();
  </script>
</body>
</html>